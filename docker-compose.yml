# ════════════════════════════════════════════════════════════════
# ContainerHub - Docker Compose (Local Development)
# ════════════════════════════════════════════════════════════════
# 
# This docker-compose file provides local development environment:
# - PostgreSQL database
# - Redis cache
# - pgAdmin (database management UI)
#
# Usage:
#   Start:  docker-compose up -d
#   Stop:   docker-compose down
#   Logs:   docker-compose logs -f
#   Reset:  docker-compose down -v (WARNING: deletes data!)
#
# ════════════════════════════════════════════════════════════════

version: '3.8'

services:
  # ──────────────────────────────────────────────────────────────
  # PostgreSQL Database
  # ──────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: containerhub_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: containerhub
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - containerhub_network

  # ──────────────────────────────────────────────────────────────
  # Redis Cache & Session Store
  # ──────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: containerhub_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass containerhub_redis_pass
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - containerhub_network

  # ──────────────────────────────────────────────────────────────
  # pgAdmin (Database Management UI) - OPTIONAL
  # ──────────────────────────────────────────────────────────────
  # Access at: http://localhost:5050
  # Login: admin@containerhub.local / admin
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: containerhub_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@containerhub.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - containerhub_network
    profiles:
      - tools  # Only start with: docker-compose --profile tools up

# ════════════════════════════════════════════════════════════════
# Volumes (Persistent Data Storage)
# ════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
    driver: local
    name: containerhub_postgres_data
  redis_data:
    driver: local
    name: containerhub_redis_data
  pgadmin_data:
    driver: local
    name: containerhub_pgadmin_data

# ════════════════════════════════════════════════════════════════
# Networks
# ════════════════════════════════════════════════════════════════
networks:
  containerhub_network:
    driver: bridge
    name: containerhub_network

# ════════════════════════════════════════════════════════════════
# NOTES:
# 
# 1. Database Connection String (from backend):
#    postgresql://postgres:postgres@localhost:5432/containerhub
#
# 2. Redis Connection String (from backend):
#    redis://:containerhub_redis_pass@localhost:6379
#
# 3. To connect to PostgreSQL from pgAdmin:
#    Host: postgres (NOT localhost when inside container)
#    Port: 5432
#    Username: postgres
#    Password: postgres
#
# 4. Data Persistence:
#    All data is stored in Docker volumes
#    To backup: docker run --rm -v containerhub_postgres_data:/data -v $(pwd):/backup ubuntu tar czf /backup/postgres_backup.tar.gz /data
#
# 5. Clean Reset:
#    docker-compose down -v && docker-compose up -d
#
# ════════════════════════════════════════════════════════════════
